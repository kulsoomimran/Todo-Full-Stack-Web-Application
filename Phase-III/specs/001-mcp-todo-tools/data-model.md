# Data Model: MCP Server & Tooling Integration

**Date**: 2026-02-13
**Feature**: 001-mcp-todo-tools
**Phase**: Phase 1 - Design & Contracts

## Overview

This document defines the data structures, schemas, and data flow for the MCP tool integration. All tools operate on the existing Todo entity with strict schema contracts for inputs and outputs.

## Core Entities

### 1. Task (Todo)

**Description**: The primary business entity representing a user's task/todo item.

**Attributes**:
- `id` (int): Unique identifier, auto-generated by database
- `user_id` (str): Owner identifier, enforces user isolation
- `title` (str): Task title, 1-255 characters, required
- `description` (str | None): Optional task description, 0-1000 characters
- `completed` (bool): Completion status, defaults to False
- `created_at` (datetime): Creation timestamp, UTC, auto-generated
- `updated_at` (datetime): Last modification timestamp, UTC, auto-updated

**Validation Rules**:
- `title`: Non-empty, max 255 characters
- `description`: Optional, max 1000 characters if provided
- `user_id`: Non-empty string
- `id`: Positive integer
- Timestamps: ISO 8601 format, UTC timezone

**Database Mapping**:
- Table: `todos`
- Primary Key: `id`
- Foreign Key: `user_id` → `user.id`
- Indexes: `user_id` (for efficient user-scoped queries)

---

### 2. Tool Input Schemas

All tool inputs follow a consistent pattern with `user_id` as the first required parameter.

#### AddTaskInput

**Purpose**: Create a new task for a user

**Fields**:
```python
user_id: str          # Required, non-empty
title: str            # Required, 1-255 chars
description: str?     # Optional, 0-1000 chars
```

**Validation**:
- `user_id`: Must be non-empty string
- `title`: Must be 1-255 characters
- `description`: If provided, max 1000 characters

**Example**:
```json
{
  "user_id": "user-123",
  "title": "Complete project documentation",
  "description": "Write comprehensive docs for MCP integration"
}
```

---

#### ListTasksInput

**Purpose**: Retrieve all tasks for a user

**Fields**:
```python
user_id: str          # Required, non-empty
```

**Validation**:
- `user_id`: Must be non-empty string

**Example**:
```json
{
  "user_id": "user-123"
}
```

---

#### UpdateTaskInput

**Purpose**: Update task properties (title and/or description)

**Fields**:
```python
user_id: str          # Required, non-empty
task_id: int          # Required, positive integer
title: str?           # Optional, 1-255 chars if provided
description: str?     # Optional, 0-1000 chars if provided
```

**Validation**:
- `user_id`: Must be non-empty string
- `task_id`: Must be positive integer
- `title`: If provided, must be 1-255 characters
- `description`: If provided, max 1000 characters
- At least one of `title` or `description` should be provided (enforced by tool logic)

**Example**:
```json
{
  "user_id": "user-123",
  "task_id": 42,
  "title": "Updated task title"
}
```

---

#### CompleteTaskInput

**Purpose**: Toggle task completion status

**Fields**:
```python
user_id: str          # Required, non-empty
task_id: int          # Required, positive integer
```

**Validation**:
- `user_id`: Must be non-empty string
- `task_id`: Must be positive integer

**Example**:
```json
{
  "user_id": "user-123",
  "task_id": 42
}
```

---

#### DeleteTaskInput

**Purpose**: Permanently delete a task

**Fields**:
```python
user_id: str          # Required, non-empty
task_id: int          # Required, positive integer
```

**Validation**:
- `user_id`: Must be non-empty string
- `task_id`: Must be positive integer

**Example**:
```json
{
  "user_id": "user-123",
  "task_id": 42
}
```

---

### 3. Tool Output Schemas

#### TaskOutput

**Purpose**: Standard representation of a single task

**Fields**:
```python
id: int               # Task identifier
title: str            # Task title
description: str?     # Task description (null if not set)
completed: bool       # Completion status
user_id: str          # Owner identifier
created_at: str       # ISO 8601 timestamp (UTC)
updated_at: str       # ISO 8601 timestamp (UTC)
```

**Example**:
```json
{
  "id": 42,
  "title": "Complete project documentation",
  "description": "Write comprehensive docs for MCP integration",
  "completed": false,
  "user_id": "user-123",
  "created_at": "2026-02-13T10:30:00Z",
  "updated_at": "2026-02-13T10:30:00Z"
}
```

---

#### TaskListOutput

**Purpose**: Collection of tasks for list_tasks tool

**Fields**:
```python
tasks: List[TaskOutput]   # Array of task objects
count: int                # Total number of tasks
```

**Example**:
```json
{
  "tasks": [
    {
      "id": 42,
      "title": "Task 1",
      "description": null,
      "completed": false,
      "user_id": "user-123",
      "created_at": "2026-02-13T10:30:00Z",
      "updated_at": "2026-02-13T10:30:00Z"
    },
    {
      "id": 43,
      "title": "Task 2",
      "description": "Details",
      "completed": true,
      "user_id": "user-123",
      "created_at": "2026-02-13T09:00:00Z",
      "updated_at": "2026-02-13T11:00:00Z"
    }
  ],
  "count": 2
}
```

---

#### DeleteTaskOutput

**Purpose**: Confirmation of successful deletion

**Fields**:
```python
success: bool         # Always true on success
message: str          # Confirmation message
```

**Example**:
```json
{
  "success": true,
  "message": "Task 42 deleted successfully"
}
```

---

### 4. Error Response Schema

**Purpose**: Standardized error format for all tools

**Structure**:
```python
error: {
  code: str           # Error code enum
  message: str        # Human-readable error message
  details: dict?      # Optional additional context
}
```

**Error Codes**:
- `VALIDATION_ERROR`: Invalid input data (400)
- `AUTH_ERROR`: Missing or invalid user_id (401)
- `PERMISSION_DENIED`: User doesn't own the task (403)
- `NOT_FOUND`: Task doesn't exist (404)
- `SERVER_ERROR`: Internal server error (500)

**Examples**:

Validation Error:
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid input data",
    "details": {
      "field": "title",
      "constraint": "String should have at least 1 character"
    }
  }
}
```

Auth Error:
```json
{
  "error": {
    "code": "AUTH_ERROR",
    "message": "Invalid user ID format: "
  }
}
```

Not Found:
```json
{
  "error": {
    "code": "NOT_FOUND",
    "message": "Todo with id 42 not found"
  }
}
```

Permission Denied:
```json
{
  "error": {
    "code": "PERMISSION_DENIED",
    "message": "Access denied to todo with id 42"
  }
}
```

Server Error:
```json
{
  "error": {
    "code": "SERVER_ERROR",
    "message": "Internal server error"
  }
}
```

---

## Data Flow

### Tool Invocation Flow

```
┌─────────────────┐
│   AI Agent      │
│  (External)     │
└────────┬────────┘
         │
         │ 1. Tool Call (JSON input)
         ▼
┌─────────────────────────────┐
│   MCP Server                │
│                             │
│  ┌──────────────────────┐  │
│  │ Input Validation     │  │ 2. Validate schema
│  │ (Pydantic)           │  │
│  └──────────┬───────────┘  │
│             │               │
│             │ 3. Validated input
│             ▼               │
│  ┌──────────────────────┐  │
│  │ Tool Implementation  │  │ 4. Extract user_id
│  │ (add_task, etc.)     │  │
│  └──────────┬───────────┘  │
│             │               │
│             │ 5. Call service
│             ▼               │
│  ┌──────────────────────┐  │
│  │ Service Layer        │  │ 6. Validate ownership
│  │ (TodoService)        │  │    Execute operation
│  └──────────┬───────────┘  │
└─────────────┼───────────────┘
              │
              │ 7. Database query
              ▼
┌─────────────────────────────┐
│   Database                  │
│   (PostgreSQL)              │
│                             │
│   todos table               │
│   - user_id scoping         │
│   - ownership validation    │
└─────────────┬───────────────┘
              │
              │ 8. Result
              ▼
┌─────────────────────────────┐
│   MCP Server                │
│                             │
│  ┌──────────────────────┐  │
│  │ Response Formatting  │  │ 9. Convert to TaskOutput
│  │ (Pydantic)           │  │
│  └──────────┬───────────┘  │
└─────────────┼───────────────┘
              │
              │ 10. JSON response
              ▼
┌─────────────────┐
│   AI Agent      │
│  (External)     │
└─────────────────┘
```

### Error Flow

```
┌─────────────────┐
│   Tool Call     │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────┐
│   Validation Error?         │
│   (Pydantic)                │
└────┬────────────────────┬───┘
     │ Yes                │ No
     ▼                    ▼
┌─────────────┐    ┌──────────────────┐
│ Return      │    │ Service Layer    │
│ VALIDATION_ │    │ Execution        │
│ ERROR       │    └────┬─────────┬───┘
└─────────────┘         │         │
                        │ Error   │ Success
                        ▼         ▼
              ┌──────────────┐  ┌──────────┐
              │ Map Exception│  │ Format   │
              │ to Error Code│  │ Response │
              └──────┬───────┘  └────┬─────┘
                     │               │
                     ▼               ▼
              ┌──────────────────────┐
              │ Return Error/Success │
              └──────────────────────┘
```

---

## Schema Validation Rules

### Pydantic Configuration

All schemas use Pydantic v2 with strict validation:

```python
from pydantic import BaseModel, Field, ConfigDict

class StrictBaseModel(BaseModel):
    model_config = ConfigDict(
        strict=True,           # No type coercion
        validate_assignment=True,  # Validate on assignment
        extra='forbid'         # Reject unknown fields
    )
```

### Field Validation

**String Fields**:
- `user_id`: `Field(min_length=1)` - Non-empty
- `title`: `Field(min_length=1, max_length=255)` - Required length
- `description`: `Field(default=None, max_length=1000)` - Optional with max

**Integer Fields**:
- `id`: `Field(gt=0)` - Positive integers only
- `task_id`: `Field(gt=0)` - Positive integers only

**Boolean Fields**:
- `completed`: No additional validation (true/false only)

**Datetime Fields**:
- Serialized as ISO 8601 strings
- Always UTC timezone
- Format: `YYYY-MM-DDTHH:MM:SSZ`

---

## Database Schema

### todos Table

```sql
CREATE TABLE todos (
    id SERIAL PRIMARY KEY,
    user_id VARCHAR NOT NULL,
    title VARCHAR(255) NOT NULL,
    description VARCHAR(1000),
    completed BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
    FOREIGN KEY (user_id) REFERENCES user(id),
    INDEX idx_user_id (user_id)
);
```

**Indexes**:
- Primary: `id` (auto-created)
- Foreign Key: `user_id` (for user isolation queries)

**Constraints**:
- `user_id`: NOT NULL, references user table
- `title`: NOT NULL, max 255 chars
- `completed`: NOT NULL, default FALSE

---

## Data Transformation

### Service Layer → MCP Output

The service layer returns `TodoResponse` objects which are transformed to `TaskOutput`:

```python
# Service layer returns:
TodoResponse(
    id=42,
    title="Task",
    description="Details",
    completed=False,
    user_id="user-123",
    created_at=datetime(...),
    updated_at=datetime(...)
)

# MCP tool transforms to:
TaskOutput(
    id=42,
    title="Task",
    description="Details",
    completed=False,
    user_id="user-123",
    created_at="2026-02-13T10:30:00Z",  # ISO 8601 string
    updated_at="2026-02-13T10:30:00Z"   # ISO 8601 string
)
```

**Transformation Logic**:
- Direct field mapping (no renaming)
- Datetime → ISO 8601 string conversion
- Null handling for optional description field

---

## Security Considerations

### User Isolation

**Enforcement Points**:
1. **Input Validation**: user_id required on all tool inputs
2. **Service Layer**: All queries filter by user_id
3. **Ownership Validation**: Task-specific operations verify ownership before modification

**Query Pattern**:
```sql
SELECT * FROM todos WHERE id = ? AND user_id = ?
```

Never:
```sql
SELECT * FROM todos WHERE id = ?  -- Missing user_id filter!
```

### Data Exposure

**What's Exposed**:
- Task data for authenticated user only
- Error messages without internal details
- Validation errors with field-level feedback

**What's Hidden**:
- Other users' tasks (404 instead of 403 for security)
- Database errors (mapped to generic SERVER_ERROR)
- Stack traces and internal paths

---

## Performance Characteristics

### Query Patterns

**list_tasks**:
```sql
SELECT * FROM todos WHERE user_id = ?
-- Index: idx_user_id
-- Expected: <10ms for typical user (100-1000 tasks)
```

**get/update/delete by id**:
```sql
SELECT * FROM todos WHERE id = ? AND user_id = ?
-- Index: PRIMARY (id) + idx_user_id
-- Expected: <5ms (indexed lookup)
```

**create_todo**:
```sql
INSERT INTO todos (...) VALUES (...)
-- Expected: <10ms (single insert)
```

### Optimization Notes

- User_id index critical for list_tasks performance
- Composite index (user_id, id) could optimize task-specific queries
- Connection pooling reduces overhead (reuse existing pool)
- Pydantic validation: ~1-5ms overhead per request

---

**Data Model Status**: ✅ Complete - Ready for contract generation
